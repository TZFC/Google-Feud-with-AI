<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>哔哩哔哩联想搜索猜词小游戏</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .page_wrapper {
      width: 100%;
      max-width: 900px;
      padding: 24px;
    }

    .card {
      background: #020617;
      border-radius: 16px;
      border: 1px solid #1f2937;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
    }

    .card_title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #e5e7eb;
    }

    .label {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
      color: #9ca3af;
    }

    .text_input {
      width: 100%;
      box-sizing: border-box;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
      outline: none;
    }

    .text_input:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px #0ea5e9;
    }

    .button_row {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }

    .button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.15s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .button_primary {
      background: linear-gradient(135deg, #0ea5e9, #22c55e);
      color: #0b1120;
      box-shadow: 0 10px 25px rgba(34, 197, 94, 0.35);
    }

    .button_primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(34, 197, 94, 0.5);
    }

    .button_primary:active {
      transform: translateY(0);
      box-shadow: 0 8px 20px rgba(34, 197, 94, 0.4);
    }

    .button_secondary {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
    }

    .button_secondary:hover {
      background: #1f2937;
    }

    .status_row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      font-size: 14px;
      color: #9ca3af;
    }

    .status_highlight {
      font-weight: 600;
      color: #e5e7eb;
    }

    .answers_grid {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 8px;
    }

    .answer_slot {
      padding: 8px 10px;
      border-radius: 10px;
      background: #020617;
      border: 1px dashed #374151;
      font-size: 13px;
      color: #9ca3af;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: border-color 0.15s ease, background 0.15s ease, color 0.15s ease, box-shadow 0.15s ease;
    }

    /* 正常进行中被揭示的答案（非游戏结束态） */
    .answer_slot_revealed {
      border-style: solid;
      border-color: #22c55e;
      color: #e5e7eb;
      background: radial-gradient(circle at top left, rgba(34, 197, 94, 0.18), transparent);
    }

    /* 游戏结束后：成功猜中的答案（绿） */
    .answer_slot_guessed {
      border-style: solid;
      border-color: #22c55e;
      color: #e5e7eb;
      background: radial-gradient(circle at top left, rgba(34, 197, 94, 0.25), transparent);
    }

    /* 游戏结束后：从未猜中的答案（红） */
    .answer_slot_missed {
      border-style: solid;
      border-color: #ef4444;
      color: #fecaca;
      background: radial-gradient(circle at top left, rgba(248, 113, 113, 0.3), transparent);
    }

    /* 重复猜测时闪烁蓝色 3 秒 */
    @keyframes flashBlue {
      0% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.6);
        border-color: #3b82f6;
      }
      50% {
        box-shadow: 0 0 0 6px rgba(59, 130, 246, 0);
        border-color: #60a5fa;
      }
      100% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
        border-color: #3b82f6;
      }
    }

    .answer_slot_repeat_flash {
      animation: flashBlue 0.5s ease-in-out 6; /* 0.5s * 6 = 3 秒 */
    }

    .answer_index_badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #111827;
      color: #9ca3af;
      margin-right: 6px;
    }

    .answer_text {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .answer_points {
      font-size: 11px;
      color: #22c55e;
      margin-left: 8px;
      opacity: 0.8;
    }

    .message_area {
      margin-top: 10px;
      font-size: 14px;
      min-height: 20px;
    }

    .message_success {
      color: #22c55e;
    }

    .message_error {
      color: #f97316;
    }

    .message_info {
      color: #60a5fa;
    }

    .prefix_display {
      font-size: 16px;
      margin-top: 4px;
      color: #e5e7eb;
    }

    .prefix_label {
      font-size: 13px;
      color: #9ca3af;
    }

    .game_over_badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(239, 68, 68, 0.15);
      color: #fecaca;
      font-size: 12px;
      margin-left: 10px;
      border: 1px solid rgba(239, 68, 68, 0.4);
    }
  </style>
</head>
<body>
<div class="page_wrapper">
  <div class="card">
    <div class="card_title">哔哩哔哩联想搜索猜词小游戏</div>
    <label class="label" for="prefix_input_element">
      输入哔哩哔哩搜索前缀（例如：<span style="color:#e5e7eb;">谁是</span>）
    </label>
    <input id="prefix_input_element" class="text_input" type="text" placeholder="在这里输入搜索前缀">

    <label class="label" for="maximum_strikes_input_element" style="margin-top:8px;">
      达到多少次错误后游戏结束
    </label>
    <input id="maximum_strikes_input_element" class="text_input" type="number" min="1" value="5">

    <div class="button_row">
      <button id="start_round_button_element" class="button button_primary">
        开始新回合
      </button>
    </div>

    <div id="round_message_element" class="message_area message_info"></div>
  </div>

  <div class="card">
    <div class="card_title">
      当前回合
      <span id="game_over_badge_element" class="game_over_badge" style="display:none;">
        游戏结束
      </span>
    </div>

    <div class="prefix_label">搜索前缀：</div>
    <div id="current_prefix_display_element" class="prefix_display">无</div>

    <div class="status_row">
      <div>
        当前得分：
        <span id="score_value_element" class="status_highlight">0</span>
      </div>
      <div>
        错误次数：
        <span id="strikes_value_element" class="status_highlight">0</span>
        /
        <span id="maximum_strikes_value_element">0</span>
      </div>
    </div>

    <div class="answers_grid" id="answers_grid_element">
      <!-- 动态填充 -->
    </div>
  </div>

  <div class="card">
    <div class="card_title">进行猜测</div>

    <label class="label" for="guess_suffix_input_element">
      模拟搜索框：左侧为固定前缀，只能在右侧继续输入后缀
    </label>

    <!-- 模拟搜索框：左边前缀不可编辑，右边输入后缀 -->
    <div class="text_input" style="display:flex; align-items:center; padding-left:0;">
      <span id="guess_prefix_element"
            style="padding:10px 8px; background:#111827; border-right:1px solid #4b5563; user-select:none; color:#9ca3af; white-space:nowrap;">
      </span>
      <input id="guess_suffix_input_element"
             type="text"
             style="flex:1; padding:10px 12px; border:none; outline:none; background:transparent; color:#e5e7eb;"
             placeholder="在前缀后继续输入完整搜索词…">
    </div>

    <div class="button_row">
      <button id="guess_button_element" class="button button_primary">
        提交猜测
      </button>
      <button id="clear_guess_button_element" class="button button_secondary">
        清空输入
      </button>
    </div>

    <div id="guess_message_element" class="message_area"></div>
  </div>
</div>

<script>
  let current_round_identifier = null;
  let current_search_term_prefix = "";
  let current_maximum_strikes = 0;
  let current_score = 0;
  let current_strikes = 0;
  let current_revealed_answers = [];
  let current_game_over_flag = false;

  // 记录哪些答案是“通过猜测”成功命中的（用于回合结束时区分绿 / 红）
  let current_guessed_flags = [];

  const score_table = [1000, 900, 800, 700, 600, 500, 400, 300, 200, 100];

  const prefix_input_element = document.getElementById("prefix_input_element");
  const maximum_strikes_input_element = document.getElementById("maximum_strikes_input_element");
  const start_round_button_element = document.getElementById("start_round_button_element");
  const round_message_element = document.getElementById("round_message_element");

  const current_prefix_display_element = document.getElementById("current_prefix_display_element");
  const score_value_element = document.getElementById("score_value_element");
  const strikes_value_element = document.getElementById("strikes_value_element");
  const maximum_strikes_value_element = document.getElementById("maximum_strikes_value_element");
  const answers_grid_element = document.getElementById("answers_grid_element");
  const game_over_badge_element = document.getElementById("game_over_badge_element");

  const guess_prefix_element = document.getElementById("guess_prefix_element");
  const guess_suffix_input_element = document.getElementById("guess_suffix_input_element");
  const guess_button_element = document.getElementById("guess_button_element");
  const clear_guess_button_element = document.getElementById("clear_guess_button_element");
  const guess_message_element = document.getElementById("guess_message_element");

  function update_round_display() {
    current_prefix_display_element.textContent = current_search_term_prefix || "无";
    score_value_element.textContent = String(current_score);
    strikes_value_element.textContent = String(current_strikes);
    maximum_strikes_value_element.textContent = String(current_maximum_strikes);

    if (current_game_over_flag) {
      game_over_badge_element.style.display = "inline-flex";
    } else {
      game_over_badge_element.style.display = "none";
    }

    answers_grid_element.innerHTML = "";

    if (!current_revealed_answers || current_revealed_answers.length === 0) {
      const empty_message_element = document.createElement("div");
      empty_message_element.style.fontSize = "13px";
      empty_message_element.style.color = "#6b7280";
      empty_message_element.textContent = "请先开始一个回合，下面会显示答案槽位。";
      answers_grid_element.appendChild(empty_message_element);
      return;
    }

    current_revealed_answers.forEach(function(answer_text, answer_index) {
      const is_revealed_flag = answer_text !== null && answer_text !== undefined;

      const answer_slot_element = document.createElement("div");
      answer_slot_element.setAttribute("data-answer-index", String(answer_index));

      let slot_class_name = "answer_slot";

      if (is_revealed_flag) {
        if (current_game_over_flag) {
          // 游戏结束态：猜中过的绿色，没猜中的红色
          if (current_guessed_flags[answer_index]) {
            slot_class_name += " answer_slot_guessed";
          } else {
            slot_class_name += " answer_slot_missed";
          }
        } else {
          // 游戏进行中：统一绿色样式
          slot_class_name += " answer_slot_revealed";
        }
      }

      answer_slot_element.className = slot_class_name;

      const left_group_element = document.createElement("div");
      left_group_element.style.display = "flex";
      left_group_element.style.alignItems = "center";
      left_group_element.style.flex = "1";

      const index_badge_element = document.createElement("span");
      index_badge_element.className = "answer_index_badge";
      index_badge_element.textContent = "#" + (answer_index + 1);
      left_group_element.appendChild(index_badge_element);

      const answer_text_element = document.createElement("span");
      answer_text_element.className = "answer_text";
      answer_text_element.textContent = is_revealed_flag ? answer_text : "未揭示";
      left_group_element.appendChild(answer_text_element);

      answer_slot_element.appendChild(left_group_element);

      if (answer_index < score_table.length) {
        const points_element = document.createElement("span");
        points_element.className = "answer_points";
        points_element.textContent = "+" + score_table[answer_index] + " 分";
        answer_slot_element.appendChild(points_element);
      }

      answers_grid_element.appendChild(answer_slot_element);
    });
  }

  async function start_new_round() {
    const prefix_value = prefix_input_element.value;
    const maximum_strikes_value = Number(maximum_strikes_input_element.value);

    round_message_element.className = "message_area message_info";
    round_message_element.textContent = "正在创建回合…";

    const response = await fetch("http://localhost:8000/api/start_round", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        search_term_prefix: prefix_value,
        maximum_strikes: maximum_strikes_value
      })
    });

    if (!response.ok) {
      round_message_element.className = "message_area message_error";
      round_message_element.textContent = "创建回合失败，请检查后端服务是否正常运行。";
      return;
    }

    const response_body = await response.json();

    current_round_identifier = response_body.round_identifier;
    current_search_term_prefix = response_body.search_term_prefix;
    current_maximum_strikes = response_body.maximum_strikes;
    current_score = 0;
    current_strikes = 0;
    current_game_over_flag = false;
    current_revealed_answers = response_body.masked_answers;

    // 初始化“是否已通过猜测命中”的标记
    current_guessed_flags = new Array(current_revealed_answers.length).fill(false);

    guess_message_element.textContent = "";
    guess_message_element.className = "message_area";

    guess_prefix_element.textContent = current_search_term_prefix;
    guess_suffix_input_element.value = "";
    guess_suffix_input_element.focus();

    round_message_element.className = "message_area message_success";
    round_message_element.textContent = "回合已开始，可以开始猜词！";

    update_round_display();
  }

  async function submit_guess() {
    if (!current_round_identifier) {
      guess_message_element.className = "message_area message_error";
      guess_message_element.textContent = "当前没有进行中的回合，请先点击“开始新回合”。";
      return;
    }

    if (current_game_over_flag) {
      guess_message_element.className = "message_area message_error";
      guess_message_element.textContent = "本回合已经结束，请开始新的回合。";
      return;
    }

    const suffix_value = guess_suffix_input_element.value;
    const full_guess_value = current_search_term_prefix + suffix_value;

    if (!full_guess_value || full_guess_value.trim().length === 0) {
      guess_message_element.className = "message_area message_error";
      guess_message_element.textContent = "请输入要猜的完整搜索词。";
      return;
    }

    guess_message_element.className = "message_area message_info";
    guess_message_element.textContent = "正在提交猜测…";

    const response = await fetch("http://localhost:8000/api/guess", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        round_identifier: current_round_identifier,
        guess_text: full_guess_value
      })
    });

    if (!response.ok) {
      guess_message_element.className = "message_area message_error";
      guess_message_element.textContent = "提交猜测失败，请检查后端服务是否正常运行。";
      return;
    }

    const response_body = await response.json();

    // 在更新状态之前，先判断这次是否“重复猜中已经猜过的答案”
    const correct_index = response_body.correct_index;
    const is_model_correct = response_body.is_correct && correct_index !== -1;
    let is_repeat_guess = false;

    if (is_model_correct) {
      if (current_guessed_flags[correct_index]) {
        // 之前已经被标记为“通过猜测命中过”
        is_repeat_guess = true;
      } else {
        // 第一次成功命中该答案
        current_guessed_flags[correct_index] = true;
      }
    }

    // 同步后端返回的其他状态
    current_score = response_body.score;
    current_strikes = response_body.strikes;
    current_game_over_flag = response_body.game_over;
    current_revealed_answers = response_body.revealed_answers;
    current_search_term_prefix = response_body.search_term_prefix;
    guess_prefix_element.textContent = current_search_term_prefix;

    // 更新界面（会刷新答案卡片 DOM）
    update_round_display();

    // 根据情况显示提示信息，并处理重复猜测的蓝色闪烁
    if (is_model_correct) {
      if (is_repeat_guess) {
        guess_message_element.className = "message_area message_info";
        guess_message_element.textContent = "这个联想结果你已经猜中过了（不加分，也不扣次数）。";

        const slot_element = document.querySelector(
          '.answer_slot[data-answer-index="' + String(correct_index) + '"]'
        );
        if (slot_element) {
          slot_element.classList.add("answer_slot_repeat_flash");
          setTimeout(function() {
            slot_element.classList.remove("answer_slot_repeat_flash");
          }, 3000);
        }
      } else {
        guess_message_element.className = "message_area message_success";
        const human_index = correct_index + 1;
        guess_message_element.textContent = "回答正确！你首次猜中了第 " + human_index + " 个联想结果。";
      }
    } else {
      guess_message_element.className = "message_area message_error";
      if (current_game_over_flag) {
        guess_message_element.textContent = "回答错误，错误次数已达上限，本回合结束，所有答案已揭示。";
      } else {
        guess_message_element.textContent = "回答错误，请再试一次。";
      }
    }
  }

  function clear_guess_input() {
    guess_suffix_input_element.value = "";
    guess_suffix_input_element.focus();
    guess_message_element.textContent = "";
    guess_message_element.className = "message_area";
  }

  start_round_button_element.addEventListener("click", function() {
    start_new_round();
  });

  guess_button_element.addEventListener("click", function() {
    submit_guess();
  });

  clear_guess_button_element.addEventListener("click", function() {
    clear_guess_input();
  });

  guess_suffix_input_element.addEventListener("keydown", function(event_object) {
    if (event_object.key === "Enter") {
      submit_guess();
    }
  });

  update_round_display();
</script>
</body>
</html>
